(()=>{"use strict";const e={elementSelectorInputAudio:".element_input_audio",elementSelectorInputOffset:".element_input_offset",elementSelectorInputBackground:".element_input_background",elementSelectorInputSpectrum:".element_input_spectrum",elementSelectorTextareaLyrics:".element_textarea_lyrics",elementSelectorTextareaHeader:".element_textarea_header",elementSelectorTextareaFooter:".element_textarea_footer",elementSelectorButtonExport:".element_button_export",elementSelectorButtonFullscreen:".element_button_fullscreen",elementSelectorAudio:".element_audio",elementSelectorContainerControl:".element_container_controll",elementSelectorCanvas:".element_canvas_preview",elementSelectorBgColor:"#element_input_bg_color",elementSelectorKeyColor:"#element_input_key_color",lyricsDataParsed:[],lyricsStateIsPlaying:!1,lyricsStateIsRecording:!1,lyricsStateRenderSpectrum:!0,lyricsResourceBackground:null,lyricsAnimationRequestID:null,lyricsAudioContext:null,lyricsAudioAnalyser:null,lyricsAudioSource:null,lyricsAudioFrequencyData:null,lyricsCanvasContext:null,lyricsPreviewWidth:1920,lyricsPreviewHeight:1080,lyricsFramesPerSecond:60,lyricsFontFace:"Nexa Black",lyricsInstrumentalSymbol:"♪",lyricsExportFileName:"lyrics-export",lyricsHeaderFirstRender:!0,lyricsBackgroundCurrentOpacity:.9,lyricsFadeSpeed:.02,lyricsBgColor:localStorage.getItem("lyricsBgColor")||"#000000",lyricsKeyColor:localStorage.getItem("lyricsKeyColor")||"#ffde59",lyricsPersistenceKeys:{audio:"persistent_audio_file",background:"persistent_bg_file",bgType:"persistent_bg_type"}},t=e=>{const t=[],r=/\[(\d{1,2}):(\d{2})(?:\.(\d{1,3}))?\]/g;for(const n of e.split(/\r?\n/)){const e=n.trim();if(!e)continue;let i;r.lastIndex=0;let l=0;const c=[];for(;null!==(i=r.exec(e));){const e=parseInt(i[1],10),t=parseInt(i[2],10),n=i[3]?parseInt((i[3]+"00").slice(0,3),10):0;c.push(1e3*(60*e+t)+n),l=r.lastIndex}const o=e.slice(l).trim(),a=o.length?o.charAt(0).toUpperCase()+o.slice(1):o;if(c.length)for(const e of c)t.push({timeMs:e,text:a})}return t.sort((e,t)=>e.timeMs-t.timeMs),t},r=(e,t)=>`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, ${t})`,n=(t,r,n,i)=>{if(!r||!r.length)return;t.font=i.font,t.textAlign="center",t.textBaseline=i.baseline;const l=.5;if(1===r.length)return t.save(),t.globalAlpha=l,t.fillStyle="#ffffff",t.fillText(r[0],i.x,i.y),void t.restore();const c=n/1e3,o=i.lineDuration||6,a=r.length,s=Math.floor(c/o)%a,u=c%o;let y=l;if(u<1)y=u/1*l;else if(u>o-1){y=l-(u-(o-1))/1*l}const d=s%2==0?e.lyricsKeyColor:"#ffffff";t.save();const m=Math.max(0,Math.min(l,y));t.globalAlpha=m,t.fillStyle=d,t.fillText(r[s],i.x,i.y),t.restore()},i=(t,i)=>{const l=document.querySelector(e.elementSelectorInputOffset),c=document.querySelector(e.elementSelectorAudio),o=t+1e3*(parseFloat(l?.value)||0);if("video"===e.lyricsResourceBackground?.type){const t=e.lyricsResourceBackground.element;t.paused&&!t.ended&&(t.muted=!0,t.playsInline=!0,t.play().catch(()=>{}))}const a=e.lyricsBgColor,s=e.lyricsKeyColor;i.clearRect(0,0,e.lyricsPreviewWidth,e.lyricsPreviewHeight);let u=-1;const y=e.lyricsDataParsed.length;if(y>0)for(let t=0;t<y&&e.lyricsDataParsed[t].timeMs<=o;t++)u=t;u<0&&y>0&&(u=0);const d=y>0?e.lyricsDataParsed[u].timeMs:0,m=u+1<y?e.lyricsDataParsed[u+1].timeMs:1e3*c.duration,p=m-o,g=u>=0&&e.lyricsDataParsed[u]?.text||"",f=u+1<y&&e.lyricsDataParsed[u+1].text||"",v=u>0?e.lyricsDataParsed[u-1].text:"",S=g.includes(e.lyricsInstrumentalSymbol),x=f.includes(e.lyricsInstrumentalSymbol),C=v.includes(e.lyricsInstrumentalSymbol),h=u>=y-2&&""===g.trim()&&""===f.trim(),A=S?"":g,w=x?"":f,I=C?"":v;let P=.9;(h||S)&&(P=0,!x&&""!==f.trim()&&p<1500&&(P=.9));e.lyricsBackgroundCurrentOpacity>P?e.lyricsBackgroundCurrentOpacity=Math.max(P,e.lyricsBackgroundCurrentOpacity-.08):e.lyricsBackgroundCurrentOpacity<P&&(e.lyricsBackgroundCurrentOpacity=Math.min(P,e.lyricsBackgroundCurrentOpacity+.08));const b=parseInt(a.slice(1,3),16),F=parseInt(a.slice(3,5),16),R=parseInt(a.slice(5,7),16);i.save(),e.lyricsResourceBackground?(((e,t,r,n)=>{const i=t.element,l="video"===t.type?i.videoWidth:i.width,c="video"===t.type?i.videoHeight:i.height;if(!l||!c)return;const o=l/c;let a,s,u,y;o>r/n?(s=n,a=n*o,u=(r-a)/2,y=0):(a=r,s=r/o,u=0,y=(n-s)/2),e.drawImage(i,u,y,a,s)})(i,e.lyricsResourceBackground,e.lyricsPreviewWidth,e.lyricsPreviewHeight),i.fillStyle=`rgba(${b}, ${F}, ${R}, ${e.lyricsBackgroundCurrentOpacity})`,i.fillRect(0,0,e.lyricsPreviewWidth,e.lyricsPreviewHeight),e.lyricsBackgroundCurrentOpacity<.3&&(i.fillStyle=`rgba(${b}, ${F}, ${R}, 0.1)`,i.fillRect(0,0,e.lyricsPreviewWidth,e.lyricsPreviewHeight))):(i.fillStyle=a,i.fillRect(0,0,e.lyricsPreviewWidth,e.lyricsPreviewHeight)),i.restore();const B=Math.max(0,e.lyricsBackgroundCurrentOpacity/.9),k=document.querySelector(e.elementSelectorTextareaHeader),_=document.querySelector(e.elementSelectorTextareaFooter);if(k?.value.trim()&&B>.01){i.save(),i.globalAlpha=B;const t=k.value.split(/\r?\n/).map(e=>e.trim()).filter(Boolean);n(i,t,o,{font:`48px "${e.lyricsFontFace}", sans-serif`,x:e.lyricsPreviewWidth/2,y:120,baseline:"top"}),i.restore()}if(_?.value.trim()&&B>.01){i.save(),i.globalAlpha=B;const t=_.value.split(/\r?\n/).map(e=>e.trim()).filter(Boolean);n(i,t,o,{font:`32px "${e.lyricsFontFace}", sans-serif`,x:e.lyricsPreviewWidth/2,y:e.lyricsPreviewHeight-120,baseline:"bottom"}),i.restore()}if(0===y)return;const E=Math.max(0,Math.min(1,(o-d)/(m-d))),T=.55*e.lyricsPreviewHeight,q=120*E;if(i.textAlign="center",i.textBaseline="middle",I){i.save();const t=S||h?Math.max(0,.5*(1-(o-d)/200)):.5*(1-E);i.font=`${/^\(.*\)$/.test(I)?"italic ":""}82px "${e.lyricsFontFace}", sans-serif`,i.fillStyle="#ffffff",i.globalAlpha=t,i.fillText(I,e.lyricsPreviewWidth/2,T-120-q),i.restore()}if(A&&(i.save(),i.font=`${/^\(.*\)$/.test(A)?"italic ":""}82px "${e.lyricsFontFace}", sans-serif`,i.fillStyle=s,i.fillText(A,e.lyricsPreviewWidth/2,T-q),i.restore()),w){i.save();const t=p<=1e3?.5*(1-p/1e3):0;i.font=`${/^\(.*\)$/.test(w)?"italic ":""}82px "${e.lyricsFontFace}", sans-serif`,i.fillStyle="#ffffff",i.globalAlpha=Math.max(0,t),i.fillText(w,e.lyricsPreviewWidth/2,T+120-q),i.restore()}e.lyricsStateRenderSpectrum&&(i.save(),(t=>{if(!e.lyricsAudioAnalyser||!e.lyricsAudioFrequencyData)return;const n=e.lyricsKeyColor||"#3b82f6";e.lyricsAudioAnalyser.getByteFrequencyData(e.lyricsAudioFrequencyData);const i=Math.floor(e.lyricsAudioFrequencyData.length/80),l=e.lyricsPreviewWidth/2/80,c=.12*e.lyricsPreviewHeight,o=e.lyricsPreviewHeight,a=t.createLinearGradient(0,o,0,o-c);a.addColorStop(0,r(n,.1)),a.addColorStop(1,r(n,.9)),t.fillStyle=a;for(let r=0;r<80;r++){let n=0;for(let t=0;t<i;t++){const l=e.lyricsAudioFrequencyData[r*i+t];l>n&&(n=l)}n<5&&(n=0);const a=n/255*c*(1-r/79*.98),s=o-a,u=r*l;t.fillRect(u,s,l-3,a);const y=e.lyricsPreviewWidth/2+(80-r-1)*l;t.fillRect(y,s,l-3,a)}})(i),i.restore())},l=()=>{const t=document.querySelector(e.elementSelectorAudio);i(1e3*t.currentTime,e.lyricsCanvasContext),e.lyricsAnimationRequestID=requestAnimationFrame(l)},c=t=>{if(!e.lyricsAudioContext){e.lyricsAudioContext=new(window.AudioContext||window.webkitAudioContext),e.lyricsAudioAnalyser=e.lyricsAudioContext.createAnalyser(),e.lyricsAudioAnalyser.fftSize=1024,e.lyricsAudioAnalyser.smoothingTimeConstant=.1,e.lyricsAudioSource=e.lyricsAudioContext.createMediaElementSource(t);const r=e.lyricsAudioContext.createBiquadFilter();r.type="lowshelf",r.frequency.value=150,r.gain.value=6;const n=e.lyricsAudioContext.createGain();n.gain.value=1,e.lyricsAudioSource.connect(r),r.connect(e.lyricsAudioAnalyser),e.lyricsAudioAnalyser.connect(n),n.connect(e.lyricsAudioContext.destination),e.lyricsAudioFrequencyData=new Uint8Array(e.lyricsAudioAnalyser.frequencyBinCount)}},o=(e,t)=>{localStorage.setItem(e,t)},a=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return localStorage.getItem(e)??t},s=e=>{if(!e)return"";let t=e.normalize("NFC");t=t.replace(/[\u0000-\u0008\u000B-\u000C\u000E-\u001F\u007F-\u009F]/g,""),t=t.replace(/[\u200B-\u200D\uFEFF\u2060-\u206F]/g,"");const r={е:"e",Е:"E",о:"o",О:"O",ӏ:"l",І:"I",ı:"i",ѕ:"s",ᴀ:"A",ʙ:"B",ᴄ:"C",ᴇ:"E",ɢ:"G",ʜ:"H",ɪ:"I",ᴊ:"J",ᴋ:"K",ʟ:"L",ᴍ:"M",ɴ:"N",ᴏ:"O",ᴘ:"P",ʀ:"R",ᴛ:"T",ᴜ:"U",ᴡ:"W",ʏ:"Y",ᴢ:"Z","∕":"/","꞉":":"};return t=t.replace(/./g,e=>r[e]||e),t.split(/\r?\n/).map(e=>e.replace(/ +/g," ").trim()).join("\n")},u="AssetsStore",y=()=>new Promise((e,t)=>{const r=indexedDB.open("LyricsAppDB",1);r.onupgradeneeded=()=>{r.result.createObjectStore(u)},r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)}),d=async(e,t)=>{(await y()).transaction(u,"readwrite").objectStore(u).put(t,e)},m=async e=>{const t=await y();return new Promise(r=>{const n=t.transaction(u).objectStore(u).get(e);n.onsuccess=()=>r(n.result),n.onerror=()=>r(null)})},p=document.querySelector(e.elementSelectorInputOffset),g=document.querySelector(e.elementSelectorInputSpectrum),f=document.querySelector(e.elementSelectorInputBackground),v=document.querySelector(e.elementSelectorInputAudio),S=document.querySelector(e.elementSelectorTextareaLyrics),x=document.querySelector(e.elementSelectorTextareaHeader),C=document.querySelector(e.elementSelectorTextareaFooter),h=document.querySelector(e.elementSelectorButtonExport),A=document.querySelector(e.elementSelectorButtonFullscreen),w=document.querySelector(e.elementSelectorAudio),I=document.querySelector(e.elementSelectorContainerControl),P=document.querySelector(e.elementSelectorCanvas),b=document.querySelector(e.elementSelectorBgColor),F=document.querySelector(e.elementSelectorKeyColor);e.lyricsCanvasContext=P.getContext("2d",{alpha:!0});const R=async()=>{if(e.lyricsAudioContext&&"suspended"===e.lyricsAudioContext.state)try{await e.lyricsAudioContext.resume()}catch(e){console.error("Failed to resume AudioContext:",e)}};b.addEventListener("input",t=>{const r=t.target.value;e.lyricsBgColor=r,o("lyrics_bg_color",r),e.lyricsStateIsPlaying||i(1e3*w.currentTime,e.lyricsCanvasContext)}),F.addEventListener("input",t=>{const r=t.target.value;e.lyricsKeyColor=r,o("lyrics_key_color",r),e.lyricsStateIsPlaying||i(1e3*w.currentTime,e.lyricsCanvasContext)}),v.addEventListener("change",async t=>{const r=t.target.files?.[0];r&&(await d(e.lyricsPersistenceKeys.audio,r),w.src=URL.createObjectURL(r),w.load(),c(w),e.lyricsExportFileName=r.name.replace(/\.[^/.]+$/,""))}),f.addEventListener("change",async t=>{const r=t.target.files?.[0];if(!r)return;e.lyricsResourceBackground?.element?.src&&URL.revokeObjectURL(e.lyricsResourceBackground.element.src);const n=r.type.startsWith("image/")?"image":"video";await d(e.lyricsPersistenceKeys.background,r),o(e.lyricsPersistenceKeys.bgType,n);const l=URL.createObjectURL(r);if("image"===n){const t=new Image;t.onload=()=>{e.lyricsResourceBackground={type:"image",element:t},i(1e3*w.currentTime,e.lyricsCanvasContext)},t.src=l}else{const t=document.createElement("video");t.muted=t.loop=t.playsInline=!0,t.onloadeddata=()=>{e.lyricsResourceBackground={type:"video",element:t},i(1e3*w.currentTime,e.lyricsCanvasContext)},t.src=l,t.load()}}),S.addEventListener("input",()=>{const r=s(S.value);S.value=r,e.lyricsDataParsed=t(r),i(1e3*w.currentTime,e.lyricsCanvasContext),o("lyrics_textarea",r)});const B=(t,r)=>{e.lyricsStateIsPlaying||i(1e3*w.currentTime,e.lyricsCanvasContext),o(t,r.value)};x.addEventListener("input",()=>B("lyrics_header",x)),C.addEventListener("input",()=>B("lyrics_footer",C)),p.addEventListener("input",()=>{o("lyrics_offset",p.value),e.lyricsStateIsPlaying||i(1e3*w.currentTime,e.lyricsCanvasContext)}),A.addEventListener("click",()=>{document.fullscreenElement?document.exitFullscreen():P.requestFullscreen().catch(console.error)}),w.addEventListener("loadedmetadata",()=>{I.classList.replace("hidden","grid")}),h.addEventListener("click",async()=>{if(!w.src)return alert("Silakan masukkan file audio terlebih dahulu.");h.disabled=!0,h.textContent="Recording...",e.lyricsStateIsRecording=!0;try{await(t=w,new Promise((e,r)=>{if(t.readyState>=2)return e();const n=()=>{l(),e()},i=()=>{l(),r(new Error("Audio resource failed to load."))},l=()=>{t.removeEventListener("canplay",n),t.removeEventListener("error",i)};t.addEventListener("canplay",n),t.addEventListener("error",i)})),await R();const r=document.createElement("canvas");r.width=e.lyricsPreviewWidth,r.height=e.lyricsPreviewHeight;const n=r.getContext("2d",{alpha:!0}),l=r.captureStream(e.lyricsFramesPerSecond);let c=new MediaStream;if(l.getVideoTracks().forEach(e=>c.addTrack(e)),w.captureStream){w.captureStream().getAudioTracks().forEach(e=>c.addTrack(e))}else{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createMediaElementSource(w),r=e.createMediaStreamDestination();t.connect(r),t.connect(e.destination),r.stream.getAudioTracks().forEach(e=>c.addTrack(e))}const o={mimeType:"video/webm;codecs=vp9,opus"},a=new MediaRecorder(c,MediaRecorder.isTypeSupported(o.mimeType)?o:{}),s=[];a.ondataavailable=e=>e.data.size&&s.push(e.data),a.onstop=()=>{const t=new Blob(s,{type:"video/webm"}),r=URL.createObjectURL(t),n=document.createElement("a");n.href=r,n.download=`${e.lyricsExportFileName}.webm`,n.click(),h.disabled=!1,h.textContent="Export",e.lyricsStateIsRecording=!1},a.start(),w.currentTime=0,await w.play();const u=()=>{e.lyricsStateIsRecording&&(i(1e3*w.currentTime,n),w.ended||w.currentTime>=w.duration-.05?(a.stop(),w.pause()):setTimeout(u,1e3/e.lyricsFramesPerSecond))};u()}catch(t){console.error("Export Error:",t),h.disabled=!1,h.textContent="Export",e.lyricsStateIsRecording=!1}var t}),g.addEventListener("change",t=>{e.lyricsStateRenderSpectrum=t.target.checked,e.lyricsStateIsPlaying||i(1e3*w.currentTime,e.lyricsCanvasContext)}),w.addEventListener("play",async()=>{await R(),e.lyricsAnimationRequestID&&cancelAnimationFrame(e.lyricsAnimationRequestID),e.lyricsAnimationRequestID=requestAnimationFrame(l),e.lyricsStateIsPlaying=!0}),w.addEventListener("pause",()=>{e.lyricsAnimationRequestID&&(cancelAnimationFrame(e.lyricsAnimationRequestID),e.lyricsAnimationRequestID=null,e.lyricsStateIsPlaying=!1)}),w.addEventListener("seeked",()=>i(1e3*w.currentTime,e.lyricsCanvasContext)),(async()=>{S.value=s(a("lyrics_textarea","[00:00.00] Intro\n[00:05.00] Lirik Baris Pertama")),x.value=a("lyrics_header",""),C.value=a("lyrics_footer",""),p.value=a("lyrics_offset","0"),b.value=e.lyricsBgColor,F.value=e.lyricsKeyColor,e.lyricsDataParsed=t(S.value);const r=await m(e.lyricsPersistenceKeys.audio);r&&(w.src=URL.createObjectURL(r),w.load(),c(w));const n=await m(e.lyricsPersistenceKeys.background),l=a(e.lyricsPersistenceKeys.bgType,"");if(n&&l){const t=URL.createObjectURL(n);if("image"===l){const r=new Image;r.src=t,r.onload=()=>{e.lyricsResourceBackground={type:"image",element:r},i(1e3*w.currentTime,e.lyricsCanvasContext)}}else{const r=document.createElement("video");r.src=t,r.muted=!0,r.loop=!0,r.playsInline=!0,r.onloadeddata=()=>{r.play().catch(()=>{}),e.lyricsResourceBackground={type:"video",element:r},i(1e3*w.currentTime,e.lyricsCanvasContext)}}}requestAnimationFrame(()=>{i(0,e.lyricsCanvasContext)})})()})();
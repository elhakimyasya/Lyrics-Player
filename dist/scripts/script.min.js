(()=>{const e=document.querySelector(".element_input_audio"),t=document.querySelector(".element_input_offset"),n=document.querySelector(".element_input_background"),r=document.querySelector(".element_textarea_lyrics"),a=document.querySelector(".element_button_fullscreen"),o=document.querySelector(".element_button_export"),l=document.querySelector(".element_audio"),i=document.querySelector(".element_container_controll"),c=document.querySelector(".element_canvas_preview");let s=[],d=!1,u=!1,m=null,f=null,p="Nexa Black",g="lyrics-export";const v=c.width,y=c.height,h=c.getContext("2d",{alpha:!0}),x=e=>Math.max(0,Math.min(1,e)),w=(e,n)=>{const r=e+1e3*(parseFloat(t.value)||0);if(n.clearRect(0,0,v,y),f){try{n.drawImage(f.el,0,0,v,y)}catch(e){console.log("Error drawing background:",e)}n.fillStyle="rgba(0, 0, 0, 0.12)",n.fillRect(0,0,v,y)}if(!s.length)return n.fillStyle="#000",n.font=`76px "${p}", Inter, sans-serif`,n.textAlign="center",n.textBaseline="middle",void n.fillText("—",v/2,y/2);let a=-1;for(let e=0;e<s.length&&s[e].timeMs<=r;e++)a=e;a<0&&(a=0);const o=s[a].timeMs,i=s[a+1]?s[a+1].timeMs:1e3*l.duration,c=x((r-o)/(i-o)),d=.55*y,u=120*c,m=d-120-u,g=d-u,h=d+120-u;n.textAlign="center",n.textBaseline="middle";const w=s[a]?s[a].text:"",E=s[a-1]?s[a-1].text:"",b=s[a+1]?s[a+1].text:"";let L=1;if(E){if(w.includes("♪")){L=x(1-c/.1)}else L=1-c;n.font=`82px "${p}", Inter, sans-serif`,n.fillStyle="#fff",n.globalAlpha=L,n.fillText(E,v/2,m)}n.font=`82px "${p}", Inter, sans-serif`,n.fillStyle="#ffde59",n.globalAlpha=1,n.fillText(w,v/2,g);let T=c;if(w.includes("♪")){const e=i-r,t=Math.min(500,i-o);T=e<t?1-e/t:0}b&&(n.font=`82px "${p}", Inter, sans-serif`,n.fillStyle="#fff",n.globalAlpha=T,n.fillText(b,v/2,h)),n.globalAlpha=1},E=()=>{w(1e3*l.currentTime,h),m=requestAnimationFrame(E)},b=e=>{const t=[],n=/\[(\d{1,2}):(\d{2})(?:\.(\d{1,3}))?\]/g;for(const r of e.split(/\r?\n/)){const e=r.trim();if(!e)continue;let a;n.lastIndex=0;let o=0;const l=[];for(;null!==(a=n.exec(e));){const e=parseInt(a[1],10),t=parseInt(a[2],10),r=a[3]?parseInt((a[3]+"00").slice(0,3),10):0;l.push(1e3*(60*e+t)+r),o=n.lastIndex}const i=e.slice(o).trim();if(l.length)for(const e of l)t.push({timeMs:e,text:i})}return t.sort((e,t)=>e.timeMs-t.timeMs),t};e.addEventListener("change",e=>{const t=e.target.files&&e.target.files[0];t&&(l.src=URL.createObjectURL(t),l.load(),g=`${t.name.replace(/\.[^/.]+$/,"")}`)}),a.addEventListener("click",e=>{document.fullscreenElement?document.exitFullscreen():c.requestFullscreen().catch(console.error)}),l.addEventListener("loadedmetadata",()=>{i.classList.add("grid"),i.classList.remove("hidden")}),r.addEventListener("input",()=>{s=b(r.value),w(1e3*l.currentTime,h)}),t.addEventListener("input",()=>{u||w(1e3*l.currentTime,h)}),n.addEventListener("change",e=>{const t=e.target.files&&e.target.files[0];if(f=null,!t)return;const n=URL.createObjectURL(t);if(t.type.startsWith("image/")){const e=new Image;e.src=n,e.onload=()=>{f={type:"image",el:e},w(1e3*l.currentTime,h)}}else if(t.type.startsWith("video/")){const e=document.createElement("video");e.src=n,e.muted=!0,e.loop=!0,e.playsInline=!0,e.onloadeddata=()=>{e.play().catch(e=>{console.log("Error playing video:",e)}),f={type:"video",el:e},w(1e3*l.currentTime,h)},e.load()}}),o.addEventListener("click",async()=>{if(!l.src)return void alert("Please load an audio file first.");const e=l.duration;if(!isFinite(e)||e<=0)alert("Audio duration unknown — play once then try export.");else{o.disabled=!0,o.textContent="Recording…",d=!0;try{await(t=l,new Promise((e,n)=>{if(t.readyState>=2)return e();function r(){o(),e()}function a(){o(),n(new Error("Cannot load audio"))}function o(){t.removeEventListener("canplay",r),t.removeEventListener("error",a)}t.addEventListener("canplay",r),t.addEventListener("error",a)}));const e=document.createElement("canvas");e.width=v,e.height=y;const n=e.getContext("2d",{alpha:!0}),r=e.captureStream(60);let a=null;if("function"==typeof l.captureStream)try{a=l.captureStream()}catch(e){console.log("Error capturing audio stream:",e),a=null}const i=new MediaStream;if(r.getVideoTracks().forEach(e=>i.addTrack(e)),a&&a.getAudioTracks().length)a.getAudioTracks().forEach(e=>i.addTrack(e));else{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createMediaElementSource(l),n=e.createMediaStreamDestination();t.connect(n),t.connect(e.destination),n.stream.getAudioTracks().forEach(e=>i.addTrack(e))}const c=["video/webm;codecs=vp9,opus","video/webm;codecs=vp8,opus","video/webm"];let s;for(const e of c)try{s=new MediaRecorder(i,{mimeType:e});break}catch(t){console.log(`MediaRecorder with mimeType "${e}" failed:`,t),s=null}s||(s=new MediaRecorder(i));const u=[];s.ondataavailable=e=>{e.data&&e.data.size&&u.push(e.data)},s.onstop=()=>{const e=new Blob(u,{type:"video/webm"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download=`${g}.webm`,n.click(),URL.revokeObjectURL(t),o.disabled=!1,o.textContent="Export",d=!1},s.start(),l.currentTime=0,await l.play();const m=Math.round(1e3/60),f=setInterval(()=>{if(w(1e3*l.currentTime,n),l.ended||l.currentTime>=l.duration-.05){try{s.stop()}catch(e){console.log("Error stopping recorder:",e)}clearInterval(f),l.pause()}},m)}catch(e){console.log(e),alert("Export failed: "+(e&&e.message?e.message:e)),o.disabled=!1,o.textContent="Record",d=!1}var t}}),l.addEventListener("play",()=>{m&&cancelAnimationFrame(m),m=requestAnimationFrame(E),u=!0}),l.addEventListener("pause",()=>{m&&(cancelAnimationFrame(m),m=null,u=!1)}),l.addEventListener("seeked",()=>w(1e3*l.currentTime,h)),r.value="[00:00.00] Intro\n[00:05.00] First lyric line\n[00:10.00] Second lyric line\n[00:15.00] Third lyric line",s=b(r.value),w(0,h),window.addEventListener("beforeunload",e=>{if(d)return e.preventDefault(),e.returnValue="",""})})();
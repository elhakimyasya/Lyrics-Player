(()=>{"use strict";var e={d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};e.d({},{W:()=>i});const t=e=>{const t=[],r=/\[(\d{1,2}):(\d{2})(?:\.(\d{1,3}))?\]/g;for(const n of e.split(/\r?\n/)){const e=n.trim();if(!e)continue;let l;r.lastIndex=0;let i=0;const c=[];for(;null!==(l=r.exec(e));){const e=parseInt(l[1],10),t=parseInt(l[2],10),n=l[3]?parseInt((l[3]+"00").slice(0,3),10):0;c.push(1e3*(60*e+t)+n),i=r.lastIndex}const a=e.slice(i).trim(),o=a.length?a.charAt(0).toUpperCase()+a.slice(1):a;if(c.length)for(const e of c)t.push({timeMs:e,text:o})}return t.sort((e,t)=>e.timeMs-t.timeMs),t},r=(e,t)=>{const r=document.querySelector(i.elementTextareaHeader),l=document.querySelector(i.elementTextareaFooter),c=document.querySelector(i.elementAudio),a=e+1e3*(parseFloat(document.querySelector(i.elementInputOffset).value)||0);if(t.clearRect(0,0,i.lyricsPreviewWidth,i.lyricsPreviewHeight),i.lyricsBackground){try{t.drawImage(i.lyricsBackground.el,0,0,i.lyricsPreviewWidth,i.lyricsPreviewHeight)}catch(e){console.log("Error drawing background:",e)}t.fillStyle="rgba(0, 0, 0, 0.12)",t.fillRect(0,0,i.lyricsPreviewWidth,i.lyricsPreviewHeight)}if(!i.lyricsParsed.length)return t.fillStyle="#000",t.font=`76px "${i.lyricsFont}", Inter, sans-serif`,t.textAlign="center",t.textBaseline="middle",void t.fillText("—",i.lyricsPreviewWidth/2,i.lyricsPreviewHeight/2);let o=-1;for(let e=0;e<i.lyricsParsed.length&&i.lyricsParsed[e].timeMs<=a;e++)o=e;o<0&&(o=0);const s=i.lyricsParsed[o].timeMs,d=i.lyricsParsed[o+1]?i.lyricsParsed[o+1].timeMs:1e3*c.duration,u=Math.max(0,Math.min(1,(a-s)/(d-s))),y=.55*i.lyricsPreviewHeight,m=120*u,p=y-120-m,f=y-m,g=y+120-m;t.textAlign="center",t.textBaseline="middle";const v=i.lyricsParsed[o]?i.lyricsParsed[o].text:"",h=i.lyricsParsed[o-1]?i.lyricsParsed[o-1].text:"",x=i.lyricsParsed[o+1]?i.lyricsParsed[o+1].text:"";let S=1;if(h){if(v.includes(i.lyricsInstrumentalText)){const e=.1;S=Math.max(0,Math.min(1,1-u/e))}else S=1-u;const e=/^\(.*\)$/.test(h);t.font=`${e?"italic ":""}82px "${i.lyricsFont}", Inter, sans-serif`,t.fillStyle="#fff",t.globalAlpha=S,t.fillText(h,i.lyricsPreviewWidth/2,p)}const w=/^\(.*\)$/.test(v);t.font=`${w?"italic ":""}82px "${i.lyricsFont}", Inter, sans-serif`,t.fillStyle="#ffde59",t.globalAlpha=1,t.fillText(v,i.lyricsPreviewWidth/2,f);let A=u;if(v.includes(i.lyricsInstrumentalText)){const e=d-a,t=Math.min(500,d-s);A=e<t?1-e/t:0}if(x){const e=/^\(.*\)$/.test(x);t.font=`${e?"italic ":""}82px "${i.lyricsFont}", Inter, sans-serif`,t.fillStyle="#fff",t.globalAlpha=A,t.fillText(x,i.lyricsPreviewWidth/2,g)}if(r&&r.value.trim()){const e=r.value.split(/\r?\n/).map(e=>e.trim()).filter(Boolean);n(t,e,a,{font:`48px "${i.lyricsFont}", Inter, sans-serif`,x:i.lyricsPreviewWidth/2,y:120,baseline:"top"},"lyricsHeaderFirstRender")}if(l&&l.value.trim()){const e=l.value.split(/\r?\n/).map(e=>e.trim()).filter(Boolean);n(t,e,a,{font:`32px "${i.lyricsFont}", Inter, sans-serif`,x:i.lyricsPreviewWidth/2,y:i.lyricsPreviewHeight-120,baseline:"bottom"},"lyricsHeaderFirstRender")}i.lyricsRenderSpectrum&&(t.globalAlpha=1,(e=>{if(!i.lyricsSpectrumAnalyser||!i.lyricsSpectrumFrequencyData)return;i.lyricsSpectrumAnalyser.getByteFrequencyData(i.lyricsSpectrumFrequencyData);const t=Math.floor(i.lyricsSpectrumFrequencyData.length/80),r=i.lyricsPreviewWidth/2/80,n=.12*i.lyricsPreviewHeight,l=i.lyricsPreviewHeight,c=e.createLinearGradient(0,l,0,l-n);c.addColorStop(0,"rgba(255,222,89,0.1)"),c.addColorStop(1,"rgba(255,222,89,0.9)"),e.fillStyle=c;for(let c=0;c<80;c++){let a=0;for(let e=0;e<t;e++){const r=i.lyricsSpectrumFrequencyData[c*t+e];r>a&&(a=r)}let o=a;o<5&&(o=0);const s=o/255*n*(1-c/79*.98),d=c*r,u=l-s;e.fillRect(d,u,r-3,s);const y=i.lyricsPreviewWidth/2+(80-c-1)*r;e.fillRect(y,u,r-3,s)}})(t)),window.lyricsHeaderFirstRender=!0,t.globalAlpha=1},n=(e,t,r,n,l)=>{if(!t||!t.length)return;if(e.font=n.font,e.textAlign="center",e.textBaseline=n.baseline,1===t.length)return e.fillStyle="#fff",e.globalAlpha=1,e.fillText(t[0],n.x,n.y),void(e.globalAlpha=1);const i=r/1e3,c=n.lineDuration||6,a=t.length,o=Math.floor(i/c)%a,s=i%c/c,d=.2;let u=.5;window[l]||(s<d?u=s/d:s>.8&&(u=(1-s)/d));const y=o%2==0?"#ffde59":"#fff";e.fillStyle=y,e.globalAlpha=u,e.fillText(t[o],n.x,n.y),e.globalAlpha=.5,window[l]&&(window[l]=!1)},l=()=>{const e=document.querySelector(i.elementAudio);r(1e3*e.currentTime,i.lyricsContext),i.lyricsRequestAnimationFrameID=requestAnimationFrame(l)},i={elementInputAudio:".element_input_audio",elementInputOffset:".element_input_offset",elementInputBackground:".element_input_background",elementInputSpectrum:".element_input_spectrum",elementTextareaLyrics:".element_textarea_lyrics",elementTextareaHeader:".element_textarea_header",elementTextareaFooter:".element_textarea_footer",elementButtonExport:".element_button_export",elementButtonFullscreen:".element_button_fullscreen",elementAudio:".element_audio",elementContainerControll:".element_container_controll",elementCanvas:".element_canvas_preview",lyricsParsed:[],lyricsIsPlaying:!1,lyricsIsRecording:!1,lyricsRenderSpectrum:!0,lyricsBackground:null,lyricsRequestAnimationFrameID:null,lyricsSpectrumAudioContext:null,lyricsSpectrumAnalyser:null,lyricsSpectrumSource:null,lyricsSpectrumFrequencyData:null,lyricsContext:null,lyricsPreviewWidth:1920,lyricsPreviewHeight:1080,lyricsFPS:60,lyricsFont:"Nexa Black",lyricsInstrumentalText:"♪",lyricsFileName:"lyrics-export"},c=document.querySelector(i.elementInputOffset),a=document.querySelector(i.elementInputSpectrum),o=document.querySelector(i.elementInputBackground),s=document.querySelector(i.elementInputAudio),d=document.querySelector(i.elementTextareaLyrics),u=document.querySelector(i.elementTextareaHeader),y=document.querySelector(i.elementTextareaFooter),m=document.querySelector(i.elementButtonExport),p=document.querySelector(i.elementButtonFullscreen),f=document.querySelector(i.elementAudio),g=document.querySelector(i.elementContainerControll),v=document.querySelector(i.elementCanvas);i.lyricsContext=v.getContext("2d",{alpha:!0});const h=(e,t)=>{localStorage.setItem(e,t)},x=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return localStorage.getItem(e)??t};d.value=x("lyrics_textarea","[00:00.00] Intro\n[00:05.00] First lyric line\n[00:10.00] Second lyric line\n[00:15.00] Third lyric line"),i.lyricsParsed=t(d.value),u.value=x("lyrics_header",""),y.value=x("lyrics_footer",""),r(0,i.lyricsContext),s.addEventListener("change",e=>{const t=e.target.files&&e.target.files[0];t&&(f.src=URL.createObjectURL(t),f.load(),(e=>{if(!i.lyricsSpectrumAudioContext){i.lyricsSpectrumAudioContext=new AudioContext,i.lyricsSpectrumAnalyser=i.lyricsSpectrumAudioContext.createAnalyser(),i.lyricsSpectrumAnalyser.fftSize=1024,i.lyricsSpectrumAnalyser.smoothingTimeConstant=.1,i.lyricsSpectrumSource=i.lyricsSpectrumAudioContext.createMediaElementSource(e);const t=i.lyricsSpectrumAudioContext.createBiquadFilter();t.type="lowshelf",t.frequency.value=150,t.gain.value=6;const r=i.lyricsSpectrumAudioContext.createGain();r.gain.value=1,i.lyricsSpectrumSource.connect(t),t.connect(i.lyricsSpectrumAnalyser),i.lyricsSpectrumAnalyser.connect(r),r.connect(i.lyricsSpectrumAudioContext.destination),i.lyricsSpectrumFrequencyData=new Uint8Array(i.lyricsSpectrumAnalyser.frequencyBinCount)}})(f),i.lyricsFileName=`${t.name.replace(/\.[^/.]+$/,"")}`)}),p.addEventListener("click",e=>{document.fullscreenElement?document.exitFullscreen():v.requestFullscreen().catch(console.error)}),f.addEventListener("loadedmetadata",()=>{g.classList.add("grid"),g.classList.remove("hidden")}),d.addEventListener("input",()=>{i.lyricsParsed=t(d.value),r(1e3*f.currentTime,i.lyricsContext),h("lyrics_textarea",d.value)}),u.addEventListener("input",()=>{i.lyricsIsPlaying||r(1e3*f.currentTime,i.lyricsContext),h("lyrics_header",u.value)}),y.addEventListener("input",()=>{i.lyricsIsPlaying||r(1e3*f.currentTime,i.lyricsContext),h("lyrics_footer",y.value)}),c.addEventListener("input",()=>{i.lyricsIsPlaying||r(1e3*f.currentTime,i.lyricsContext)}),o.addEventListener("change",e=>{const t=e.target.files&&e.target.files[0];if(i.lyricsBackground=null,!t)return;const n=URL.createObjectURL(t);if(t.type.startsWith("image/")){const e=new Image;e.src=n,e.onload=()=>{i.lyricsBackground={type:"image",el:e},r(1e3*f.currentTime,i.lyricsContext)}}else if(t.type.startsWith("video/")){const e=document.createElement("video");e.src=n,e.muted=!0,e.loop=!0,e.playsInline=!0,e.onloadeddata=()=>{e.play().catch(e=>{console.log("Error playing video:",e)}),i.lyricsBackground={type:"video",el:e},r(1e3*f.currentTime,i.lyricsContext)},e.load()}}),m.addEventListener("click",async()=>{if(!f.src)return void alert("Please load an audio file first.");const e=f.duration;if(!isFinite(e)||e<=0)alert("Audio duration unknown — play once then try export.");else{m.disabled=!0,m.textContent="Recording…",i.lyricsIsRecording=!0;try{await(t=f,new Promise((e,r)=>{if(t.readyState>=2)return e();function n(){i(),e()}function l(){i(),r(new Error("Cannot load audio"))}function i(){t.removeEventListener("canplay",n),t.removeEventListener("error",l)}t.addEventListener("canplay",n),t.addEventListener("error",l)}));const e=document.createElement("canvas");e.width=i.lyricsPreviewWidth,e.height=i.lyricsPreviewHeight;const n=e.getContext("2d",{alpha:!0,desynchronized:!0}),l=e.captureStream(i.lyricsFPS);let c=null;if("function"==typeof f.captureStream)try{c=f.captureStream()}catch(e){console.log("Error capturing audio stream:",e),c=null}const a=new MediaStream;if(l.getVideoTracks().forEach(e=>a.addTrack(e)),c&&c.getAudioTracks().length)c.getAudioTracks().forEach(e=>a.addTrack(e));else{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createMediaElementSource(f),r=e.createMediaStreamDestination();t.connect(r),t.connect(e.destination),r.stream.getAudioTracks().forEach(e=>a.addTrack(e))}const o=["video/webm;codecs=vp9,opus","video/webm;codecs=vp8,opus","video/webm"];let s;for(const e of o)try{s=new MediaRecorder(a,{mimeType:e});break}catch(t){console.log(`MediaRecorder with mimeType "${e}" failed:`,t),s=null}s||(s=new MediaRecorder(a));const d=[];s.ondataavailable=e=>{e.data&&e.data.size&&d.push(e.data)},s.onstop=()=>{const e=new Blob(d,{type:"video/webm"}),t=URL.createObjectURL(e),r=document.createElement("a");r.href=t,r.download=`${i.lyricsFileName}.webm`,r.click(),URL.revokeObjectURL(t),m.disabled=!1,m.textContent="Export",i.lyricsIsRecording=!1},s.start(),f.currentTime=0,await f.play();const u=Math.round(1e3/i.lyricsFPS),y=setInterval(()=>{if(r(1e3*f.currentTime,n),f.ended||f.currentTime>=f.duration-.05){try{s.stop()}catch(e){console.log("Error stopping recorder:",e)}clearInterval(y),f.pause()}},u)}catch(e){console.log(e),alert("Export failed: "+(e&&e.message?e.message:e)),m.disabled=!1,m.textContent="Record",i.lyricsIsRecording=!1}var t}}),a.addEventListener("change",e=>{i.lyricsRenderSpectrum=e.target.checked,i.lyricsIsPlaying||r(1e3*f.currentTime,i.lyricsContext)}),f.addEventListener("play",e=>{e.preventDefault(),i.lyricsRequestAnimationFrameID&&cancelAnimationFrame(i.lyricsRequestAnimationFrameID),i.lyricsRequestAnimationFrameID=requestAnimationFrame(l),i.lyricsIsPlaying=!0}),f.addEventListener("pause",e=>{e.preventDefault(),i.lyricsRequestAnimationFrameID&&(cancelAnimationFrame(i.lyricsRequestAnimationFrameID),i.lyricsRequestAnimationFrameID=null,i.lyricsIsPlaying=!1)}),f.addEventListener("seeked",()=>r(1e3*f.currentTime,i.lyricsContext)),window.addEventListener("beforeunload",e=>{if(i.lyricsIsRecording)return e.preventDefault(),e.returnValue="",""})})();